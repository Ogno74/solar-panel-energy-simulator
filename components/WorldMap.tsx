
import React, { useState, useRef, useCallback } from 'react';

interface WorldMapProps {
    latitude: number;
    longitude: number;
    onCoordsChange: (latitude: number, longitude: number) => void;
}

// Simplified world map SVG path data (equirectangular projection)
const WorldMapSvgPath = () => (
    <path
        fill="#e5e7eb"
        stroke="#9ca3af"
        strokeWidth="0.5"
        d="M612.9,293.4 L608.2,293.4 L603.5,293.4 L603.5,298.1 L594.1,298.1 L589.5,298.1 L589.5,293.4 L584.8,293.4 L580.1,293.4 L580.1,288.7 L575.4,288.7 L575.4,284.1 L575.4,279.4 L575.4,274.7 L575.4,270 L575.4,265.3 L580.1,265.3 L580.1,260.6 L580.1,256 L584.8,256 L584.8,251.3 L584.8,246.6 L584.8,241.9 L580.1,241.9 L580.1,237.2 L575.4,237.2 L575.4,232.5 L570.7,232.5 L570.7,227.9 L566,227.9 L566,223.2 L561.3,223.2 L561.3,218.5 L561.3,213.8 L556.6,213.8 L551.9,213.8 L551.9,209.1 L547.2,209.1 L547.2,204.4 L547.2,199.8 L542.5,199.8 L542.5,195.1 L537.8,195.1 L537.8,190.4 L533.1,190.4 L528.4,190.4 L528.4,185.7 L523.7,185.7 L519,185.7 L519,181 L514.3,181 L509.6,181 L505,181 L500.3,181 L495.6,181 L490.9,181 L486.2,181 L481.5,181 L476.8,181 L472.1,181 L467.4,181 L462.7,181 L462.7,176.3 L458.1,176.3 L453.4,176.3 L448.7,176.3 L444,176.3 L439.3,176.3 L434.6,176.3 L429.9,176.3 L425.2,176.3 L420.5,176.3 L415.8,176.3 L411.1,176.3 L406.4,176.3 L401.7,176.3 L397.1,176.3 L392.4,176.3 L387.7,176.3 L383,176.3 L378.3,176.3 L373.6,176.3 L368.9,176.3 L364.2,176.3 L359.5,176.3 L354.8,176.3 L350.1,176.3 L345.4,176.3 L340.8,176.3 L336.1,176.3 L331.4,176.3 L326.7,176.3 L322,176.3 L317.3,176.3 L312.6,176.3 L307.9,176.3 L303.2,176.3 L298.5,176.3 L293.8,176.3 L289.2,176.3 L284.5,176.3 L279.8,176.3 L275.1,176.3 L270.4,176.3 L265.7,176.3 L261,176.3 L256.3,176.3 L251.6,176.3 L246.9,176.3 L242.2,176.3 L237.6,176.3 L232.9,176.3 L228.2,176.3 L223.5,176.3 L218.8,176.3 L214.1,176.3 L209.4,176.3 L204.7,176.3 L200.1,176.3 L195.4,176.3 L190.7,176.3 L186,176.3 L181.3,176.3 L176.6,176.3 L171.9,176.3 L167.2,176.3 L162.5,176.3 L157.9,176.3 L153.2,176.3 L148.5,176.3 L143.8,176.3 L139.1,176.3 L134.4,176.3 L129.7,176.3 L125,176.3 L120.3,176.3 L115.7,176.3 L111,176.3 L106.3,176.3 L101.6,176.3 L96.9,176.3 L92.2,176.3 L87.5,176.3 L82.8,176.3 L78.1,176.3 L73.5,176.3 L68.8,176.3 L64.1,176.3 L59.4,176.3 L54.7,176.3 L50,176.3 L45.3,176.3 L40.6,176.3 L35.9,176.3 L31.3,176.3 L26.6,176.3 L21.9,176.3 L17.2,176.3 L12.5,176.3 L12.5,181 L7.8,181 L7.8,185.7 L3.1,185.7 L3.1,190.4 L3.1,195.1 L3.1,199.8 L3.1,204.4 L7.8,204.4 L7.8,209.1 L12.5,209.1 L12.5,213.8 L12.5,218.5 L17.2,218.5 L17.2,223.2 L21.9,223.2 L26.6,223.2 L26.6,227.9 L31.3,227.9 L35.9,227.9 L35.9,232.5 L40.6,232.5 L40.6,237.2 L45.3,237.2 L50,237.2 L54.7,237.2 L59.4,237.2 L59.4,241.9 L64.1,241.9 L64.1,246.6 L68.8,246.6 L73.5,246.6 L73.5,251.3 L78.1,251.3 L78.1,256 L82.8,256 L87.5,256 L87.5,260.6 L92.2,260.6 L96.9,260.6 L96.9,265.3 L101.6,265.3 L101.6,270 L106.3,270 L111,270 L111,274.7 L115.7,274.7 L120.3,274.7 L125,274.7 L125,279.4 L129.7,279.4 L129.7,284.1 L134.4,284.1 L139.1,284.1 L139.1,288.7 L143.8,288.7 L148.5,288.7 L148.5,293.4 L153.2,293.4 L153.2,298.1 L153.2,302.8 L157.9,302.8 L157.9,307.5 L162.5,307.5 L162.5,312.2 L167.2,312.2 L171.9,312.2 L171.9,316.9 L176.6,316.9 L176.6,321.6 L181.3,321.6 L181.3,326.3 L186,326.3 L190.7,326.3 L190.7,331 L195.4,331 L195.4,335.7 L200.1,335.7 L200.1,340.4 L204.7,340.4 L204.7,345.1 L209.4,345.1 L214.1,345.1 L218.8,345.1 L218.8,349.8 L223.5,349.8 L228.2,349.8 L232.9,349.8 L237.6,349.8 L242.2,349.8 L246.9,349.8 L251.6,349.8 L256.3,349.8 L261,349.8 L265.7,349.8 L270.4,349.8 L275.1,349.8 L279.8,349.8 L284.5,349.8 L289.2,349.8 L293.8,349.8 L298.5,349.8 L303.2,349.8 L307.9,349.8 L312.6,349.8 L317.3,349.8 L322,349.8 L326.7,349.8 L331.4,349.8 L336.1,349.8 L340.8,349.8 L345.4,349.8 L350.1,349.8 L354.8,349.8 L359.5,349.8 L364.2,349.8 L368.9,349.8 L373.6,349.8 L378.3,349.8 L383,349.8 L387.7,349.8 L392.4,349.8 L397.1,349.8 L401.7,349.8 L406.4,349.8 L411.1,349.8 L415.8,349.8 L420.5,349.8 L425.2,349.8 L429.9,349.8 L434.6,349.8 L439.3,349.8 L444,349.8 L448.7,349.8 L453.4,349.8 L458.1,349.8 L462.7,349.8 L467.4,349.8 L472.1,349.8 L476.8,349.8 L481.5,349.8 L486.2,349.8 L490.9,349.8 L495.6,349.8 L500.3,349.8 L505,349.8 L509.6,349.8 L514.3,349.8 L519,349.8 L523.7,349.8 L528.4,349.8 L533.1,349.8 L537.8,349.8 L542.5,349.8 L547.2,349.8 L551.9,349.8 L556.6,349.8 L561.3,349.8 L566,349.8 L570.7,349.8 L575.4,349.8 L575.4,345.1 L580.1,345.1 L584.8,345.1 L584.8,340.4 L589.5,340.4 L589.5,335.7 L594.1,335.7 L594.1,331 L598.8,331 L598.8,326.3 L603.5,326.3 L603.5,321.6 L608.2,321.6 L608.2,316.9 L612.9,316.9 L612.9,312.2 L612.9,307.5 L617.6,307.5 L622.3,307.5 L622.3,302.8 L627,302.8 L627,298.1 L631.7,298.1 L636.4,298.1 L636.4,293.4 L641.1,293.4 L641.1,288.7 L645.8,288.7 L645.8,284.1 L650.5,284.1 L650.5,279.4 L655.2,279.4 L655.2,274.7 L659.9,274.7 L659.9,270 L664.6,270 L669.3,270 L669.3,265.3 L674,265.3 L678.7,265.3 L678.7,260.6 L683.4,260.6 L688.1,260.6 L688.1,256 L692.8,256 L697.5,256 L697.5,251.3 L702.2,251.3 L702.2,246.6 L706.9,246.6 L706.9,241.9 L711.6,241.9 L716.3,241.9 L716.3,237.2 L721,237.2 L721,232.5 L725.7,232.5 L730.4,232.5 L730.4,227.9 L735.1,227.9 L739.8,227.9 L739.8,223.2 L744.5,223.2 L749.2,223.2 L749.2,218.5 L753.9,218.5 L758.6,218.5 L763.3,218.5 L763.3,213.8 L768,213.8 L772.7,213.8 L772.7,209.1 L777.4,209.1 L782.1,209.1 L786.8,209.1 L786.8,204.4 L791.5,204.4 L796.2,204.4 L800.9,204.4 L800.9,199.8 L805.6,199.8 L810.3,199.8 L815,199.8 L815,195.1 L819.7,195.1 L824.4,195.1 L829.1,195.1 L829.1,190.4 L833.8,190.4 L838.5,190.4 L843.2,190.4 L843.2,185.7 L847.9,185.7 L852.6,185.7 L857.3,185.7 L857.3,181 L862,181 L866.7,181 L871.4,181 L876.1,181 L880.8,181 L885.5,181 L890.2,181 L894.9,181 L899.6,181 L904.3,181 L909,181 L913.7,181 L918.4,181 L923.1,181 L927.8,181 L932.5,181 L937.2,181 L941.9,181 L946.6,181 L951.3,181 L956,181 L960.7,181 L965.4,181 L970.1,181 L974.8,181 L979.5,181 L984.2,181 L988.9,181 L993.6,181 L998.3,181 L1003,181 L1007.7,181 L1012.4,181 L1017.1,181 L1021.8,181 L1021.8,185.7 L1021.8,190.4 L1021.8,195.1 L1017.1,195.1 L1017.1,199.8 L1012.4,199.8 L1007.7,199.8 L1003,199.8 L1003,204.4 L998.3,204.4 L998.3,209.1 L993.6,209.1 L988.9,209.1 L988.9,213.8 L984.2,213.8 L979.5,213.8 L979.5,218.5 L974.8,218.5 L970.1,218.5 L970.1,223.2 L965.4,223.2 L960.7,223.2 L960.7,227.9 L956,227.9 L951.3,227.9 L951.3,232.5 L946.6,232.5 L941.9,232.5 L941.9,237.2 L937.2,237.2 L932.5,237.2 L932.5,241.9 L927.8,241.9 L923.1,241.9 L923.1,246.6 L918.4,246.6 L913.7,246.6 L909,246.6 L909,251.3 L904.3,251.3 L899.6,251.3 L894.9,251.3 L894.9,256 L890.2,256 L885.5,256 L880.8,256 L876.1,256 L876.1,260.6 L871.4,260.6 L866.7,260.6 L866.7,265.3 L862,265.3 L857.3,265.3 L857.3,270 L852.6,270 L847.9,270 L847.9,274.7 L843.2,274.7 L838.5,274.7 L838.5,279.4 L833.8,279.4 L829.1,279.4 L829.1,284.1 L824.4,284.1 L819.7,284.1 L819.7,288.7 L815,288.7 L810.3,288.7 L810.3,293.4 L805.6,293.4 L800.9,293.4 L800.9,298.1 L796.2,298.1 L791.5,298.1 L791.5,302.8 L786.8,302.8 L782.1,302.8 L782.1,307.5 L777.4,307.5 L772.7,307.5 L772.7,312.2 L768,312.2 L763.3,312.2 L763.3,316.9 L758.6,316.9 L753.9,316.9 L749.2,316.9 L749.2,321.6 L744.5,321.6 L739.8,321.6 L739.8,326.3 L735.1,326.3 L730.4,326.3 L730.4,331 L725.7,331 L721,331 L721,335.7 L716.3,335.7 L711.6,335.7 L711.6,340.4 L706.9,340.4 L702.2,340.4 L702.2,345.1 L697.5,345.1 L692.8,345.1 L692.8,349.8 L688.1,349.8 L683.4,349.8 L683.4,345.1 L678.7,345.1 L674,345.1 L674,340.4 L669.3,340.4 L664.6,340.4 L664.6,335.7 L659.9,335.7 L655.2,335.7 L655.2,331 L650.5,331 L645.8,331 L645.8,326.3 L641.1,326.3 L636.4,326.3 L636.4,321.6 L631.7,321.6 L627,321.6 L627,316.9 L622.3,316.9 L617.6,316.9 L617.6,312.2 L612.9,312.2 M998.3,227.9 L998.3,232.5 L993.6,232.5 L993.6,237.2 L988.9,237.2 L984.2,237.2 L984.2,241.9 L979.5,241.9 L974.8,241.9 L974.8,246.6 L970.1,246.6 L965.4,246.6 L965.4,251.3 L960.7,251.3 L956,251.3 L956,256 L951.3,256 L946.6,256 L946.6,260.6 L941.9,260.6 L937.2,260.6 L937.2,265.3 L932.5,265.3 L927.8,265.3 L927.8,270 L923.1,270 L918.4,270 L918.4,274.7 L913.7,274.7 L909,274.7 L904.3,274.7 L904.3,279.4 L899.6,279.4 L894.9,279.4 L890.2,279.4 L890.2,284.1 L885.5,284.1 L880.8,284.1 L876.1,284.1 L871.4,284.1 L871.4,288.7 L866.7,288.7 L862,288.7 L862,293.4 L857.3,293.4 L852.6,293.4 L852.6,298.1 L847.9,298.1 L843.2,298.1 L843.2,302.8 L838.5,302.8 L833.8,302.8 L833.8,307.5 L829.1,307.5 L824.4,307.5 L824.4,312.2 L819.7,312.2 L815,312.2 L815,316.9 L810.3,316.9 L805.6,316.9 L805.6,321.6 L800.9,321.6 L796.2,321.6 L796.2,326.3 L791.5,326.3 L786.8,326.3 L786.8,331 L782.1,331 L777.4,331 L777.4,335.7 L772.7,335.7 L768,335.7 L768,340.4 L763.3,340.4 L758.6,340.4 L758.6,345.1 L753.9,345.1 L749.2,345.1 L749.2,349.8 L744.5,349.8 L739.8,349.8 L735.1,349.8 L735.1,345.1 L730.4,345.1 L725.7,345.1 L725.7,340.4 L721,340.4 L716.3,340.4 L716.3,345.1 L711.6,345.1 L706.9,345.1 L706.9,349.8 L702.2,349.8 L697.5,349.8 L697.5,354.5 L692.8,354.5 L688.1,354.5 L683.4,354.5 L678.7,354.5 L674,354.5 L669.3,354.5 L664.6,354.5 L659.9,354.5 L655.2,354.5 L650.5,354.5 L645.8,354.5 L641.1,354.5 L636.4,354.5 L631.7,354.5 L627,354.5 L622.3,354.5 L617.6,354.5 L612.9,354.5 L608.2,354.5 L603.5,354.5 L598.8,354.5 L594.1,354.5 L589.5,354.5 L584.8,354.5 L580.1,354.5 L575.4,354.5 L570.7,354.5 L566,354.5 L561.3,354.5 L556.6,354.5 L551.9,354.5 L547.2,354.5 L542.5,354.5 L537.8,354.5 L533.1,354.5 L528.4,354.5 L523.7,354.5 L519,354.5 L514.3,354.5 L509.6,354.5 L505,354.5 L500.3,354.5 L495.6,354.5 L490.9,354.5 L486.2,354.5 L481.5,354.5 L476.8,354.5 L472.1,354.5 L467.4,354.5 L462.7,354.5 L458.1,354.5 L453.4,354.5 L448.7,354.5 L444,354.5 L439.3,354.5 L434.6,354.5 L429.9,354.5 L425.2,354.5 L420.5,354.5 L415.8,354.5 L411.1,354.5 L406.4,354.5 L401.7,354.5 L397.1,354.5 L392.4,354.5 L387.7,354.5 L383,354.5 L378.3,354.5 L373.6,354.5 L368.9,354.5 L364.2,354.5 L359.5,354.5 L354.8,354.5 L350.1,354.5 L345.4,354.5 L340.8,354.5 L336.1,354.5 L331.4,354.5 L326.7,354.5 L322,354.5 L317.3,354.5 L312.6,354.5 L307.9,354.5 L303.2,354.5 L298.5,354.5 L293.8,354.5 L289.2,354.5 L284.5,354.5 L279.8,354.5 L275.1,354.5 L270.4,354.5 L265.7,354.5 L261,354.5 L256.3,354.5 L251.6,354.5 L246.9,354.5 L242.2,354.5 L237.6,354.5 L232.9,354.5 L228.2,354.5 L223.5,354.5 L218.8,354.5 L214.1,354.5 L209.4,354.5 L204.7,354.5 L200.1,354.5 L195.4,354.5 L190.7,354.5 L186,354.5 L181.3,354.5 L176.6,354.5 L171.9,354.5 L167.2,354.5 L162.5,354.5 L157.9,354.5 L153.2,354.5 L148.5,354.5 L143.8,354.5 L139.1,354.5 L134.4,354.5 L129.7,354.5 L125,354.5 L120.3,354.5 L115.7,354.5 L111,354.5 L106.3,354.5 L101.6,354.5 L96.9,354.5 L92.2,354.5 L87.5,354.5 L82.8,354.5 L78.1,354.5 L73.5,354.5 L68.8,354.5 L64.1,354.5 L59.4,354.5 L54.7,354.5 L50,354.5 L45.3,354.5 L40.6,354.5 L35.9,354.5 L31.3,354.5 L26.6,354.5 L21.9,354.5 L17.2,354.5 L12.5,354.5 L7.8,354.5 L3.1,354.5 L3.1,349.8 L3.1,345.1 L3.1,340.4 L3.1,335.7 L7.8,335.7 L7.8,331 L12.5,331 L12.5,326.3 L17.2,326.3 L21.9,326.3 L21.9,321.6 L26.6,321.6 L31.3,321.6 L31.3,316.9 L35.9,316.9 L40.6,316.9 L45.3,316.9 L45.3,312.2 L50,312.2 L54.7,312.2 L54.7,307.5 L59.4,307.5 L64.1,307.5 L64.1,302.8 L68.8,302.8 L73.5,302.8 L78.1,302.8 L78.1,298.1 L82.8,298.1 L87.5,298.1 L87.5,293.4 L92.2,293.4 L96.9,293.4 L101.6,293.4 L101.6,288.7 L106.3,288.7 L111,288.7 L115.7,288.7 L115.7,284.1 L120.3,284.1 L125,284.1 L125,279.4 M129.7,274.7 L134.4,274.7 L134.4,270 L139.1,270 L143.8,270 L143.8,265.3 L148.5,265.3 L153.2,265.3 L153.2,260.6 L157.9,260.6 L162.5,260.6 L162.5,256 L167.2,256 L171.9,256 L171.9,251.3 L176.6,251.3 L181.3,251.3 L181.3,246.6 L186,246.6 L190.7,246.6 L190.7,241.9 L195.4,241.9 L200.1,241.9 L200.1,237.2 L204.7,237.2 L209.4,237.2 L209.4,232.5 L214.1,232.5 L218.8,232.5 L218.8,227.9 L223.5,227.9 L228.2,227.9 L228.2,223.2 L232.9,223.2 L237.6,223.2 L237.6,218.5 L242.2,218.5 L246.9,218.5 L246.9,213.8 L251.6,213.8 L256.3,213.8 L256.3,209.1 L261,209.1 L265.7,209.1 L265.7,204.4 L270.4,204.4 L275.1,204.4 L275.1,199.8 L279.8,199.8 L284.5,199.8 L284.5,195.1 L289.2,195.1 L293.8,195.1 L293.8,190.4 L298.5,190.4 L303.2,190.4 L303.2,185.7 L307.9,185.7 L312.6,185.7 L312.6,181 L317.3,181 L322,181 L322,185.7 L326.7,185.7 L331.4,185.7 L331.4,190.4 L336.1,190.4 L340.8,190.4 L340.8,195.1 L345.4,195.1 L350.1,195.1 L350.1,199.8 L354.8,199.8 L359.5,199.8 L359.5,204.4 L364.2,204.4 L368.9,204.4 L368.9,209.1 L373.6,209.1 L378.3,209.1 L378.3,213.8 L383,213.8 L387.7,213.8 L387.7,218.5 L392.4,218.5 L397.1,218.5 L397.1,223.2 L401.7,223.2 L406.4,223.2 L406.4,227.9 L411.1,227.9 L415.8,227.9 L415.8,232.5 L420.5,232.5 L425.2,232.5 L425.2,237.2 L429.9,237.2 L434.6,237.2 L434.6,241.9 L439.3,241.9 L444,241.9 L444,246.6 L448.7,246.6 L453.4,246.6 L453.4,251.3 L458.1,251.3 L462.7,251.3 L462.7,256 L467.4,256 L472.1,256 L472.1,260.6 L476.8,260.6 L481.5,260.6 L481.5,265.3 L486.2,265.3 L490.9,265.3 L490.9,270 L495.6,270 L500.3,270 L500.3,274.7 L505,274.7 L509.6,274.7 L509.6,279.4 L514.3,279.4 L519,279.4 L519,284.1 L523.7,284.1 L528.4,284.1 L528.4,288.7 L533.1,288.7 L537.8,288.7 L537.8,293.4 L542.5,293.4 L547.2,293.4 L547.2,298.1 L551.9,298.1 L556.6,298.1 L556.6,302.8 L561.3,302.8 L566,302.8 L566,307.5 L570.7,307.5 L575.4,307.5 L575.4,312.2 L575.4,316.9 L580.1,316.9 L580.1,321.6 L584.8,321.6 L584.8,326.3 L589.5,326.3 L594.1,326.3 L594.1,321.6 L598.8,321.6 L598.8,316.9 L603.5,316.9 L603.5,312.2 L603.5,307.5 L608.2,307.5 L608.2,302.8 L612.9,302.8"
    />
);

export const WorldMap: React.FC<WorldMapProps> = ({ latitude, longitude, onCoordsChange }) => {
    const mapRef = useRef<HTMLDivElement>(null);
    const [isDragging, setIsDragging] = useState(false);

    const handleInteraction = useCallback((clientX: number, clientY: number) => {
        if (!mapRef.current) return;
        const rect = mapRef.current.getBoundingClientRect();
        
        const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
        const y = Math.max(0, Math.min(clientY - rect.top, rect.height));

        const lon = (x / rect.width) * 360 - 180;
        const lat = -((y / rect.height) * 180 - 90);

        onCoordsChange(parseFloat(lat.toFixed(4)), parseFloat(lon.toFixed(4)));
    }, [onCoordsChange]);

    const handleMouseDown = (e: React.MouseEvent<HTMLDivElement>) => {
        e.preventDefault();
        setIsDragging(true);
        handleInteraction(e.clientX, e.clientY);
    };

    const handleMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (isDragging) {
            handleInteraction(e.clientX, e.clientY);
        }
    };

    const handleMouseUp = () => {
        setIsDragging(false);
    };

    const handleTouchStart = (e: React.TouchEvent<HTMLDivElement>) => {
        setIsDragging(true);
        handleInteraction(e.touches[0].clientX, e.touches[0].clientY);
    };

    const handleTouchMove = (e: React.TouchEvent<HTMLDivElement>) => {
        if (isDragging) {
            handleInteraction(e.touches[0].clientX, e.touches[0].clientY);
        }
    };

    const handleTouchEnd = () => {
        setIsDragging(false);
    };

    const left = ((longitude + 180) / 360) * 100;
    const top = ((-latitude + 90) / 180) * 100;

    return (
        <div 
            ref={mapRef}
            className="relative w-full max-w-md mx-auto aspect-[2/1] rounded-md overflow-hidden border-2 border-blue-200 cursor-crosshair touch-none select-none"
            onMouseDown={handleMouseDown}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
            onMouseLeave={handleMouseUp}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
        >
            <svg viewBox="0 0 1024 512" className="w-full h-full bg-white">
                <WorldMapSvgPath />
            </svg>
            <div
                className="absolute w-3 h-3 -translate-x-1/2 -translate-y-1/2 bg-red-500 border-2 border-white rounded-full shadow-lg pointer-events-none"
                style={{ top: `${top}%`, left: `${left}%` }}
                title={`Lat: ${latitude.toFixed(2)}, Lon: ${longitude.toFixed(2)}`}
            />
        </div>
    );
};
